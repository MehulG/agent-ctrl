services:
  approvals:
    env_file:
      - ./.env
    build:
      context: ../..
      dockerfile: demos/e2e_publish_market_report/Dockerfile
      target: backend
    environment:
      CTRL_DB_PATH: ${CTRL_DB_PATH:-/data/ctrl.db}
      CTRL_SERVERS_PATH: ${CTRL_SERVERS_PATH:-demos/e2e_publish_market_report/configs/servers.yaml}
      CTRL_POLICY_PATH: ${CTRL_POLICY_PATH:-demos/e2e_publish_market_report/configs/policy.yaml}
    volumes:
      - ctrl-data:/data
    ports:
      - "0.0.0.0:8788:8788"
    working_dir: /app
    command: ["ctrl", "approvals-serve", "--host", "0.0.0.0", "--port", "8788"]
    restart: unless-stopped

  agent:
    profiles: ["agent"]
    env_file:
      - ./.env
    build:
      context: ../..
      dockerfile: demos/e2e_publish_market_report/Dockerfile
      target: backend
    environment:
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:?set GOOGLE_API_KEY}
      CTRL_DB_PATH: ${CTRL_DB_PATH:-/data/ctrl.db}
      CTRL_SERVERS_PATH: ${CTRL_SERVERS_PATH:-demos/e2e_publish_market_report/configs/servers.yaml}
      CTRL_POLICY_PATH: ${CTRL_POLICY_PATH:-demos/e2e_publish_market_report/configs/policy.yaml}
      CTRL_RISK_PATH: ${CTRL_RISK_PATH:-demos/e2e_publish_market_report/configs/risk.yaml}
    depends_on:
      - approvals
    volumes:
      - ctrl-data:/data
    working_dir: /app
    command: >
      bash -lc "set -euo pipefail;
        ctrl validate-config --servers $${CTRL_SERVERS_PATH} --policy $${CTRL_POLICY_PATH} --db $${CTRL_DB_PATH};
        python demos/e2e_publish_market_report/agent.py"
    restart: "no"

  dashboard:
    env_file:
      - ./.env
    build:
      context: ../..
      dockerfile: demos/e2e_publish_market_report/Dockerfile
      target: dashboard
      args:
        NEXT_PUBLIC_CTRL_API_BASE: ${NEXT_PUBLIC_CTRL_API_BASE:-http://localhost:8788}
        NEXT_PUBLIC_CTRL_DB_PATH: ${NEXT_PUBLIC_CTRL_DB_PATH:-/data/ctrl.db}
        NEXT_PUBLIC_CTRL_SERVERS_PATH: ${NEXT_PUBLIC_CTRL_SERVERS_PATH:-demos/e2e_publish_market_report/configs/servers.yaml}
    environment:
      NEXT_PUBLIC_CTRL_API_BASE: ${NEXT_PUBLIC_CTRL_API_BASE:-http://localhost:8788}
      NEXT_PUBLIC_CTRL_DB_PATH: ${NEXT_PUBLIC_CTRL_DB_PATH:-/data/ctrl.db}
      NEXT_PUBLIC_CTRL_SERVERS_PATH: ${NEXT_PUBLIC_CTRL_SERVERS_PATH:-demos/e2e_publish_market_report/configs/servers.yaml}
    ports:
      - "0.0.0.0:3000:3000"
    depends_on:
      - approvals

volumes:
  ctrl-data:
